<!-- Written by Giovanni Resta giovannirestadev@gmail.com replace a string with another-->
<!DOCTYPE html>
<html lang="en">
<head>
	<title>text editor</title>
	<meta charset="utf-8">
	<link rel="stylesheet" type="text/css" href="../style.css" media="screen">
	<script type="text/javascript" async src="js/import_text_field_panel.js"></script>
</head>

<body>

<article>

<h1>Text editor</h1>

<div data-field-wrapper="some_text_area">
    <form class="bg-light p-3 rounded mx-md-5">
        <textarea id="my_textarea" class="overflow-auto form-control mb-2 w-100" style="max-height: 30em; overflow-y: auto;"></textarea>
        <input type="file" class="form-control textarea-fileinput"><br> <br><button class="dark" type="button" onclick="download()">Save</button> <br> <input id="myFilename" class="dark" type="text" value=".html" >
    </form>
<script>
    new ImportTextFieldPanel("some_text_area");
</script>
</div>

</script>

<script type="text/javascript">

function download(){
	var text = document.getElementById("my_textarea").value;
	var filename = document.getElementById("myFilename").value;
	text = text.replace(/\n/g, "\r\n"); // To retain the Line breaks.
	var blob = new Blob([text], { type: "text/plain"});
	var anchor = document.createElement("a");
	anchor.download = filename;
	anchor.href = window.URL.createObjectURL(blob);
	anchor.target ="_blank";
	anchor.style.display = "none"; // just to be safe!
	document.body.appendChild(anchor);
	anchor.click();
	document.body.removeChild(anchor);
}

// Insert tab function

document.addEventListener('DOMContentLoaded', () => {
    const textarea = document.getElementById('my_textarea');

    // Insert tab character
    const insertTabCharacter = () => {
        const { value, selectionStart, selectionEnd } = textarea;

        // Insert tab character
        textarea.value = `${value.substring(0, selectionEnd)}\t${value.substring(selectionEnd)}`;

        // Move cursor to new position
        textarea.selectionStart = textarea.selectionEnd = selectionEnd + 1;
    };

    // Add indentation to each line of selected text
    const addIndentation = () => {
        const { value, selectionStart, selectionEnd } = textarea;

        const linesBeforeCaret = value.substring(0, selectionStart).split('\n');
        const startLine = linesBeforeCaret.length - 1;
        const endLine = value.substring(0, selectionEnd).split('\n').length - 1;

        const newValue = value
            .split('\n')
            .map((line, i) => (i >= startLine && i <= endLine) ? `\t${line}` : line)
            .join('\n');

        textarea.value = newValue;

        const startLineText = linesBeforeCaret[startLine];
        textarea.selectionStart = startLineText && /\S/.test(startLineText)
                                ? selectionStart + 1
                                : selectionStart;
        textarea.selectionEnd = selectionEnd + (endLine - startLine + 1);
    };

    textarea.addEventListener('keydown', (e) => {
        if (e.key === 'Tab') {
            e.preventDefault();
            const { selectionStart, selectionEnd } = textarea;
            (selectionStart === selectionEnd)
                ? insertTabCharacter()
                : addIndentation();
        }
    });
});

function getSelectedText() 
{
	var txtArea = document.getElementById("my_textarea");
	var selectedText;   
	if (txtArea.selectionStart != undefined)
	{    
		var startPosition = txtArea.selectionStart;
		var endPosition = txtArea.selectionEnd;
		selectedText = txtArea.value.substring(startPosition, endPosition);
	}
	alert("You selected :" + selectedText);
}

//detect Ctrl-b event

let ta = document.getElementById('my_textarea');

window.onkeydown = function (e)
{
	if (!e.ctrlKey || (e.key != 'b' && e.key != 'i'))
  		return;
 	let start = ta.selectionStart;
	let end = ta.selectionEnd;
	let newval;

	if(e.key == 'b')
  		newval = ta.value.substring(0,start)+"<b>"+ta.value.substring(start,end)+"</b>"+ta.value.substring(end);
  
	if(e.key == 'i')
		newval = ta.value.substring(0,start)+"<i>"+ta.value.substring(start,end)+"</i>"+ta.value.substring(end);
    
	ta.value = newval;
	return false;
}

</script>

</article>

</body>

</html>
